const db = require('../models');
const Thing = db.things;
const Book = db.books;
const Drive = db.drives;
const Other = db.others;
const Op = db.Sequelize.Op;

// create and save a new Thing
createThing = async (req, res) => {
    if (!req.body.title || !req.body.branch || !req.body.sem) {
        res.status(400).send({
            message: 'Content can\'t be empty!'
        });
        return;
    }

    // create Thing
    const thing = {
        title: req.body.title,
        branch: req.body.branch,
        sem: req.body.sem,
        userId: req.body.userId,
        donation: req.body.donation,
    };

    let id;
    // save Thing in db
    await Thing.create(thing)
        .then(data => {
            id = data.id;
        })
        .catch(err => {
            res.status(500).send({
                message: err.message || `Error occurred while creating the Thing.`
            });
        });

    return id;
};

updateModel = async (req, res) => {
    const type = req.body.type;
    const id = req.params.id;

    let model, n;

    if (type == 'book')
        model = Book;
    else if (type == 'other')
        model = Other;
    else if (type == 'drive')
        model = Drive;
    else
        model = null;

    await model.update(req.body, { where: { thingId: id } })
        .then(num => {
            n = num;
        })
        .catch(err => {
            res.status(500).send({
                message: `Error updating Model id:${id}`
            });
            return;
        });
}

// create and  save a new Book
exports.createBook = async (req, res) => {
    if (!req.body.author || !req.body.publisher || !req.body.phone) {
        res.status(400).send({
            message: 'Content can\'t be empty!'
        });
        return;
    }

    let thingId = await createThing(req, res);

    // create Book
    const book = {
        author: req.body.author,
        publisher: req.body.publisher,
        image: req.file.path,
        phone: req.body.phone,
        thingId: thingId
    };

    // save Book in db
    Book.create(book)
        .then(data => {
            res.send({
                data,
                message: 'Book added successfully!'
            });
        })
        .catch(err => {
            res.send({
                message: `Error occurred while creating Book.`
            });
        });
}

// create and  save a new Drive
exports.createDrive = async (req, res) => {
    if (!req.body.url || !req.body.description) {
        console.log(req.body);
        res.status(400).send({
            message: 'Content can\'t be empty!'
        });
        return;
    }

    let thingId = await createThing(req, res);

    // create Drive
    const drive = {
        url: req.body.url,
        description: req.body.description,
        thingId: thingId
    };

    // all Drives are donations, additional check
    Thing.update({ donation: true }, { where: { id: thingId } })

    // save Drive in db
    Drive.create(drive)
        .then(data => {
            res.send({
                data,
                message: 'Link added successfully!'
            });
        })
        .catch(err => {
            res.send({
                message: `Error occurred while creating Drive.`
            });
        });
}

// create and  save a new Other
exports.createOther = async (req, res) => {
    if (!req.body.description || !req.body.phone) {
        res.status(400).send({
            message: 'Content can\'t be empty!'
        });
        return;
    }

    let thingId = await createThing(req, res);

    // create Other
    const other = {
        image: req.file.path,
        phone: req.body.phone,
        description: req.body.description,
        thingId: thingId
    };

    // save Other in db
    Other.create(other)
        .then(data => {
            res.send({
                data,
                message: 'Product added successfully!'
            });
        })
        .catch(err => {
            res.send({
                message: `Error occurred while creating Other.`
            });
        });
}

// retrieve all Things from db
exports.findAll = (req, res) => {
    const title = req.query.title;
    const sem = req.query.sem;
    const branch = req.query.branch;
    const donation = req.query.donation;
    const type = req.query.type;

    let matchTitle = title ? { title: { [Op.like]: `%${title}%` } } : null;
    let matchSem = sem ? { sem: { [Op.like]: `%${sem}%` } } : null;
    let matchBranch = branch ? { branch: { [Op.like]: `%${branch}%` } } : null;
    let matchDonation = donation ? { donation: { [Op.eq]: donation } } : null;

    let model;
    if (type == 'book')
        model = Book;
    else if (type == 'other')
        model = Other;
    else if (type == 'drive')
        model = Drive;
    else
        model = Thing;

    model.findAll({
        where: {
            [Op.and]: [matchTitle, matchSem, matchBranch, matchDonation]
        },
        include: (model != Thing) ? Thing : [Book, Other, Drive]
    })
        .then(data => {
            res.send(data);
        })
        .catch(err => {
            res.status(500).send({
                message: err.message || `Error occurred while searching Things.`
            });
        });
};

// TODO: fix searching, deleting, etc for each type(for book, other, drive, etc)

// find a single Thing by id
exports.findOne = (req, res) => {
    const id = req.params.id;

    Thing.findByPk(id, {
        include: [Book, Other, Drive]
    })
        .then(data => {
            res.send(data);
        })
        .catch(err => {
            res.status(500).send({
                message: err.message || `Error retrieving Thing with id:${id}`
            })
        })
};

// update a Thing by id in request
exports.update = async (req, res) => {
    const id = req.params.id;

    // check if only owner of the thing is attempting to update it
    const reqUserId = req.userData.id;

    await Thing.findByPk(id)
        .then(data => {
            if (data.dataValues.userId != reqUserId) {
                res.status(401).send({
                    message: `Not Authorized`
                })
                return;
            }
        })
        .catch(err => {
            res.status(500).send({
                message: err.message || `Error retrieving Thing with id:${id}`
            })
            return;
        })

    // updates Child specific data first
    await updateModel(req, res);

    // update Thing specific data
    Thing.update(req.body, { where: { id: id } })
        .then(num => {
            console.log(`num = ${num}`);

            if (num == 1) {
                res.send({
                    message: `Product updated successfully`
                });
            } else {
                res.send({
                    message: `Error occured while updating!`
                });
            }
        })
        .catch(err => {
            res.status(500).send({
                message: `Error updating Thing id:${id}`
            });
        });
};

// delete a Thing by id in request
exports.delete = (req, res) => {
    const id = req.params.id;

    // check if only owner of the thing is attempting to delete it
    const reqUserId = req.userData.id;
    Thing.findByPk(id)
        .then(data => {
            if (data.dataValues.userId != reqUserId) {
                res.status(401).send({
                    message: `Not Authorized`
                })
            }
        })
        .catch(err => {
            res.status(500).send({
                message: err.message || `Error retrieving Thing with id:${id}`
            })
        })

    Thing.destroy({ where: { id: id } })
        .then(num => {
            if (num == 1) {
                res.send({
                    message: `Product deleted successfully`
                });
            } else {
                res.send({
                    message: `Cannot delete Product. Maybe it was not found!`
                });
            }
        })
        .catch(err => {
            res.status(500).send({
                message: `Could not delete Thing id:${id}`
            });
        });
};

// delete all Things in db
exports.deleteAll = (req, res) => {
    Thing.destroy({
        where: {},
        truncate: false
    })
        .then(nums => {
            res.send({
                message: `${nums} Things were deleted successfully!`
            });
        })
        .catch(err => {
            res.status(500).send({
                message:
                    err.message || `Error trying to delete all Things`
            });
        });
};